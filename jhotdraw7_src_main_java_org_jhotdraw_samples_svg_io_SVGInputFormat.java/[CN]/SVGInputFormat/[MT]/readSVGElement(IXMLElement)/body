{
  Viewport viewport=new Viewport();
  viewport.width=toWidth(elem,readAttribute(elem,"width","100%"));
  viewport.height=toHeight(elem,readAttribute(elem,"height","100%"));
  if (readAttribute(elem,"viewBox","none").equals("none")) {
    viewport.viewBox.width=viewport.width;
    viewport.viewBox.height=viewport.height;
  }
 else {
    String[] viewBoxValues=toWSOrCommaSeparatedArray(readAttribute(elem,"viewBox","none"));
    viewport.viewBox.x=toNumber(elem,viewBoxValues[0]);
    viewport.viewBox.y=toNumber(elem,viewBoxValues[1]);
    viewport.viewBox.width=toNumber(elem,viewBoxValues[2]);
    viewport.viewBox.height=toNumber(elem,viewBoxValues[3]);
  }
  if (viewportStack.size() == 1) {
    viewport.isPreserveAspectRatio=true;
  }
 else {
    viewport.isPreserveAspectRatio=!readAttribute(elem,"preserveAspectRatio","none").equals("none");
  }
  viewport.widthPercentFactor=viewport.viewBox.width / 100d;
  viewport.heightPercentFactor=viewport.viewBox.height / 100d;
  viewport.numberFactor=Math.min(viewport.width / viewport.viewBox.width,viewport.height / viewport.viewBox.height);
  AffineTransform viewBoxTransform=new AffineTransform();
  viewBoxTransform.translate(-viewport.viewBox.x * viewport.width / viewport.viewBox.width,-viewport.viewBox.y * viewport.height / viewport.viewBox.height);
  if (viewport.isPreserveAspectRatio) {
    double factor=Math.min(viewport.width / viewport.viewBox.width,viewport.height / viewport.viewBox.height);
    viewBoxTransform.scale(factor,factor);
  }
 else {
    viewBoxTransform.scale(viewport.width / viewport.viewBox.width,viewport.height / viewport.viewBox.height);
  }
  readViewportAttributes(elem,viewportStack.firstElement().attributes);
  viewportStack.push(viewport);
  for (  IXMLElement node : elem.getChildren()) {
    if (node instanceof IXMLElement) {
      IXMLElement child=(IXMLElement)node;
      Figure childFigure=readElement(child);
      if (readAttribute(child,"visibility","visible").equals("visible") && !readAttribute(child,"display","inline").equals("none")) {
        if (childFigure != null) {
          childFigure.transform(viewBoxTransform);
          figures.add(childFigure);
        }
      }
    }
  }
  viewportStack.pop();
  return null;
}
