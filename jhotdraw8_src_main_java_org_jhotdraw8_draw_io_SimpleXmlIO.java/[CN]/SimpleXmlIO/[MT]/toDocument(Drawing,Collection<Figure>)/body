{
  if (selection.isEmpty() || selection.contains(internal)) {
    return toDocument(internal);
  }
  Set<Figure> s=new HashSet<>(selection);
  ArrayList<Figure> ordered=new ArrayList<>(selection.size());
  for (  Figure f : internal.preorderIterable()) {
    if (s.contains(f)) {
      ordered.add(f);
    }
  }
  try {
    Clipping external=new SimpleClipping();
    idFactory.reset();
    DocumentBuilderFactory builderFactory=DocumentBuilderFactory.newInstance();
    Document doc;
    final String docElemName=figureFactory.figureToName(external);
    if (namespaceURI != null) {
      builderFactory.setNamespaceAware(true);
      DocumentBuilder builder=builderFactory.newDocumentBuilder();
      DOMImplementation domImpl=builder.getDOMImplementation();
      doc=domImpl.createDocument(namespaceURI,namespaceQualifier == null ? docElemName : namespaceQualifier + ":" + docElemName,null);
    }
 else {
      DocumentBuilder builder=builderFactory.newDocumentBuilder();
      doc=builder.newDocument();
      Element elem=doc.createElement(docElemName);
      doc.appendChild(elem);
    }
    Element docElement=doc.getDocumentElement();
    String linebreak="\n";
    for (    Figure child : ordered) {
      writeNodeRecursively(doc,docElement,child,linebreak);
    }
    docElement.appendChild(doc.createTextNode(linebreak));
    return doc;
  }
 catch (  ParserConfigurationException ex) {
    throw new IOException(ex);
  }
}
