{
  try {
    String elementName=factory.figureToName(figure);
    if (elementName == null) {
      return;
    }
    Element elem=createElement(doc,elementName);
    writeElementAttributes(elem,figure);
    writeElementNodeList(doc,elem,figure);
    for (    String string : figure.get(XML_HEAD_COMMENT_KEY)) {
      parent.appendChild(doc.createTextNode(linebreak));
      parent.appendChild(doc.createComment(string));
    }
    for (    Figure child : figure.getChildren()) {
      if (factory.figureToName(child) != null) {
        writeNodeRecursively(doc,elem,child,linebreak + indent);
      }
    }
    boolean hasNoElementNodes=factory.figureNodeListKeys(figure).isEmpty();
    for (    String string : figure.get(XML_BODY_COMMENT_KEY)) {
      if (hasNoElementNodes) {
        elem.appendChild(doc.createTextNode(linebreak));
      }
      elem.appendChild(doc.createComment(string));
    }
    if (hasNoElementNodes && elem.getChildNodes().getLength() != 0) {
      elem.appendChild(doc.createTextNode(linebreak));
    }
    parent.appendChild(doc.createTextNode(linebreak));
    parent.appendChild(elem);
  }
 catch (  IOException e) {
    throw new IOException("Error writing figure " + figure,e);
  }
}
