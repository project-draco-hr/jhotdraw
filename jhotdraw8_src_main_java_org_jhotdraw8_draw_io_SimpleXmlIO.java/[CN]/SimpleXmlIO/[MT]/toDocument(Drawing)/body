{
  try {
    Drawing external=factory.toExternalDrawing(internal);
    factory.reset();
    DocumentBuilderFactory builderFactory=DocumentBuilderFactory.newInstance();
    Document doc;
    if (namespaceURI != null) {
      builderFactory.setNamespaceAware(true);
      DocumentBuilder builder=builderFactory.newDocumentBuilder();
      DOMImplementation domImpl=builder.getDOMImplementation();
      doc=domImpl.createDocument(namespaceURI,namespaceQualifier == null ? factory.figureToName(external) : namespaceQualifier + ":" + factory.figureToName(internal),null);
    }
 else {
      DocumentBuilder builder=builderFactory.newDocumentBuilder();
      doc=builder.newDocument();
      Element elem=doc.createElement(factory.figureToName(external));
      doc.appendChild(elem);
    }
    Element docElement=doc.getDocumentElement();
    writeProcessingInstructions(doc,external);
    String commentText=factory.createFileComment();
    if (commentText != null) {
      docElement.getParentNode().insertBefore(doc.createComment(commentText),docElement);
    }
    writeElementAttributes(docElement,external);
    for (    Figure child : external.getChildren()) {
      Node childNode=writeNodeRecursively(doc,child);
      if (childNode != null) {
        docElement.appendChild(doc.createTextNode("\n"));
        docElement.appendChild(childNode);
      }
    }
    docElement.appendChild(doc.createTextNode("\n"));
    return doc;
  }
 catch (  ParserConfigurationException ex) {
    throw new IOException(ex);
  }
}
