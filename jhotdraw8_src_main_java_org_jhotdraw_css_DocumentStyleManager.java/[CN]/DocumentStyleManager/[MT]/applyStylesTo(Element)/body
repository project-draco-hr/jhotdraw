{
  HashMap<String,String> applicableDeclarations=new HashMap<>();
  for (  Entry e : getUserAgentStylesheets()) {
    Stylesheet s=e.getStylesheet();
    if (s == null) {
      continue;
    }
    for (    StyleRule r : s.getRulesets()) {
      if (r.getSelectorGroup().matches(selectorModel,elem)) {
        for (        Declaration d : r.getDeclarations()) {
          if (!elem.hasAttribute(d.getProperty())) {
            applicableDeclarations.put(d.getProperty(),d.getTermsAsString());
          }
        }
      }
    }
  }
  for (  Entry e : getAuthorStylesheets()) {
    Stylesheet s=e.getStylesheet();
    if (s == null) {
      continue;
    }
    for (    StyleRule r : s.getRulesets()) {
      if (r.getSelectorGroup().matches(selectorModel,elem)) {
        for (        Declaration d : r.getDeclarations()) {
          applicableDeclarations.put(d.getProperty(),d.getTermsAsString());
        }
      }
    }
  }
  for (  Entry e : getInlineStylesheets()) {
    Stylesheet s=e.getStylesheet();
    if (s == null) {
      continue;
    }
    for (    StyleRule r : s.getRulesets()) {
      if (r.getSelectorGroup().matches(selectorModel,elem)) {
        for (        Declaration d : r.getDeclarations()) {
          applicableDeclarations.put(d.getProperty(),d.getTermsAsString());
        }
      }
    }
  }
  if (elem.hasAttribute("style")) {
    try {
      for (      Declaration d : parser.parseDeclarationList(elem.getAttribute("style"))) {
        applicableDeclarations.put(d.getProperty(),d.getTermsAsString());
      }
    }
 catch (    IOException ex) {
      System.err.println("DOMStyleManager: Invalid style attribute on element. style=" + elem.getAttribute("style"));
      ex.printStackTrace();
    }
  }
  for (  Map.Entry<String,String> entry : applicableDeclarations.entrySet()) {
    elem.setAttribute(entry.getKey(),entry.getValue());
  }
  applicableDeclarations.clear();
}
