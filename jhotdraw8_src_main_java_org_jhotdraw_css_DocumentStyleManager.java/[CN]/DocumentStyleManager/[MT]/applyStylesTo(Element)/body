{
  HashMap<String,String> applicableDeclarations=new HashMap<>();
  for (  Stylesheet s : userAgentStylesheets) {
    for (    Ruleset r : s.getRulesets()) {
      if (r.getSelectorGroup().matches(selectorModel,elem)) {
        for (        Declaration d : r.getDeclarations()) {
          if (!elem.hasAttribute(d.getProperty())) {
            applicableDeclarations.put(d.getProperty(),d.getTerms());
          }
        }
      }
    }
  }
  for (  Stylesheet s : authorStylesheets) {
    for (    Ruleset r : s.getRulesets()) {
      if (r.getSelectorGroup().matches(selectorModel,elem)) {
        for (        Declaration d : r.getDeclarations()) {
          applicableDeclarations.put(d.getProperty(),d.getTerms());
        }
      }
    }
  }
  if (elem.hasAttribute("style")) {
    try {
      for (      Declaration d : parser.parseDeclarations(elem.getAttribute("style"))) {
        applicableDeclarations.put(d.getProperty(),d.getTerms());
      }
    }
 catch (    IOException ex) {
      System.err.println("DOMStyleManager: Invalid style attribute on element. style=" + elem.getAttribute("style"));
      ex.printStackTrace();
    }
  }
  for (  Map.Entry<String,String> entry : applicableDeclarations.entrySet()) {
    elem.setAttribute(entry.getKey(),entry.getValue());
  }
  applicableDeclarations.clear();
}
