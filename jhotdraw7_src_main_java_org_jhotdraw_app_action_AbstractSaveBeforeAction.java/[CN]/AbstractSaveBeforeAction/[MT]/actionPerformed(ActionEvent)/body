{
  final View p=getActiveView();
  if (p.isEnabled()) {
    final ResourceBundleUtil labels=ResourceBundleUtil.getBundle("org.jhotdraw.app.Labels");
    Window wAncestor=SwingUtilities.getWindowAncestor(p.getComponent());
    oldFocusOwner=(wAncestor == null) ? null : wAncestor.getFocusOwner();
    p.setEnabled(false);
    if (p.hasUnsavedChanges()) {
      JOptionPane pane=new JOptionPane("<html>" + UIManager.getString("OptionPane.css") + labels.getString("file.saveBefore.doYouWantToSave.message"),JOptionPane.WARNING_MESSAGE);
      Object[] options={labels.getString("file.saveBefore.saveOption.text"),labels.getString("file.saveBefore.cancelOption.text"),labels.getString("file.saveBefore.dontSaveOption.text")};
      pane.setOptions(options);
      pane.setInitialValue(options[0]);
      pane.putClientProperty("Quaqua.OptionPane.destructiveOption",new Integer(2));
      JSheet.showSheet(pane,p.getComponent(),new SheetListener(){
        public void optionSelected(        SheetEvent evt){
          Object value=evt.getValue();
          if (value == null || value.equals(labels.getString("file.saveBefore.cancelOption.text"))) {
            p.setEnabled(true);
          }
 else           if (value.equals(labels.getString("file.saveBefore.dontSaveOption.text"))) {
            doIt(p);
            p.setEnabled(true);
          }
 else           if (value.equals(labels.getString("file.saveBefore.saveOption.text"))) {
            saveChanges(p);
          }
        }
      }
);
    }
 else {
      doIt(p);
      p.setEnabled(true);
      if (oldFocusOwner != null) {
        oldFocusOwner.requestFocus();
      }
    }
  }
}
