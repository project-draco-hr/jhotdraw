{
  if (!valid) {
    isValidating=true;
    DirtyMask dmStyle=DirtyMask.of(DirtyBits.STYLE);
    for (    Map.Entry<Figure,DirtyMask> entry : new ArrayList<>(dirties.entrySet())) {
      Figure f=entry.getKey();
      DirtyMask dm=entry.getValue();
      if (dm.intersects(dmStyle)) {
        f.stylesheetNotify();
        for (        Figure subf : f.preorderIterable()) {
          markDirty(subf,DirtyBits.NODE,DirtyBits.TRANSFORM,DirtyBits.LAYOUT);
        }
      }
    }
    DirtyMask dmTransformLayout=DirtyMask.of(DirtyBits.TRANSFORM,DirtyBits.LAYOUT,DirtyBits.LAYOUT_OBSERVERS);
    for (    Map.Entry<Figure,DirtyMask> entry : new ArrayList<>(dirties.entrySet())) {
      Figure f=entry.getKey();
      DirtyMask dm=entry.getValue();
      if (dm.intersects(dmTransformLayout)) {
        for (        Figure a : f.ancestorIterable()) {
          if (a instanceof TransformableFigure) {
            markDirty(a,DirtyBits.NODE,DirtyBits.TRANSFORM);
          }
          if (a.isLayoutable()) {
            markDirty(a,DirtyBits.NODE,DirtyBits.LAYOUT);
          }
        }
      }
    }
    DirtyMask dmTransform=DirtyMask.of(DirtyBits.TRANSFORM);
    DirtyMask dmTransformNotify=DirtyMask.of(DirtyBits.TRANSFORM_NOTIFY);
    for (    Map.Entry<Figure,DirtyMask> entry : new ArrayList<>(dirties.entrySet())) {
      Figure f=entry.getKey();
      DirtyMask dm=entry.getValue();
      if (dm.intersects(dmTransform) && !dm.intersects(dmTransformNotify)) {
        for (        Figure a : f.preorderIterable()) {
          markDirty(a,DirtyBits.LAYOUT,DirtyBits.TRANSFORM_NOTIFY);
        }
      }
    }
    for (    Map.Entry<Figure,DirtyMask> entry : new ArrayList<>(dirties.entrySet())) {
      Figure f=entry.getKey();
      DirtyMask dm=entry.getValue();
      if (dm.intersects(dmTransformNotify)) {
        f.transformNotify();
      }
    }
    DirtyMask dmLayout=DirtyMask.of(DirtyBits.LAYOUT);
    DirtyMask dmLayoutOrObservers=DirtyMask.of(DirtyBits.LAYOUT,DirtyBits.LAYOUT_OBSERVERS);
    List<Figure> todo=new ArrayList<>();
    for (    Map.Entry<Figure,DirtyMask> entry : new ArrayList<>(dirties.entrySet())) {
      Figure f=entry.getKey();
      DirtyMask dm=entry.getValue();
      if (dm.intersects(dmLayoutOrObservers)) {
        for (        Figure subtree : f.preorderIterable()) {
          for (          Figure d : subtree.getLayoutObservers()) {
            todo.add(d);
          }
        }
        for (        Figure a : f.ancestorIterable()) {
          if (a instanceof TransformableFigure) {
            markDirty(a,DirtyBits.NODE);
          }
        }
      }
    }
    for (    Map.Entry<Figure,DirtyMask> entry : dirties.entrySet()) {
      Figure f=entry.getKey();
      DirtyMask dm=entry.getValue();
      if (dm.intersects(dmLayout)) {
        this.layout(f);
      }
    }
    Set<Figure> transitive=new LinkedHashSet<>(todo);
    transitivelyCollectDependentFigures(todo,transitive);
    collectLayoutableAncestors(new ArrayList<>(transitive),transitive);
    for (    Figure f : transitive) {
      markDirty(f,DirtyBits.NODE);
      this.layout(f);
    }
    DirtyMask dmNode=DirtyMask.of(DirtyBits.NODE);
    for (    Map.Entry<Figure,DirtyMask> entry : dirties.entrySet()) {
      Figure f=entry.getKey();
      DirtyMask dm=entry.getValue();
      if (dm.intersects(dmNode)) {
        fireNodeInvalidated(f);
      }
    }
    for (    Map.Entry<Figure,DirtyMask> entry : dirties.entrySet()) {
      Figure f=entry.getKey();
      DirtyMask dm=entry.getValue();
      if (dm.intersects(dmTransform)) {
        f.transformNotify();
      }
    }
    dirties.clear();
    isValidating=false;
    valid=true;
  }
}
