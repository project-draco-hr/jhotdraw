{
  Element elem=doc.createElement(factory.figureToName(figure));
  elem.setAttribute("id",ids.createId(figure));
  for (  Key<?> k : factory.figureKeys(figure)) {
    Key<Object> key=(Key<Object>)k;
    Object value=figure.get(key);
    if (!factory.isDefaultValue(key,value)) {
      if (Figure.class.isAssignableFrom(key.getValueType())) {
        elem.setAttribute(factory.keyToName(figure,key),ids.createId(value));
      }
 else {
        elem.setAttribute(factory.keyToName(figure,key),factory.valueToString(key,value));
      }
    }
  }
  for (  Figure child : figure.childrenProperty()) {
    if (factory.figureToName(child) != null) {
      elem.appendChild(doc.createTextNode("\n"));
      elem.appendChild(writeNodeRecursively(doc,child));
    }
  }
  if (!figure.childrenProperty().isEmpty()) {
    elem.appendChild(doc.createTextNode("\n"));
  }
  return elem;
}
