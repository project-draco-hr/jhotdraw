{
  factory.reset();
  figureToElementMap.clear();
  Drawing external=null;
  NodeList list=doc.getChildNodes();
  for (int i=0; i < list.getLength(); i++) {
    Figure f=readNodesRecursively(list.item(i));
    if (f instanceof Drawing) {
      external=(Drawing)f;
      break;
    }
  }
  if (external == null) {
    if (namespaceURI == null) {
      throw new IOException("The document does not contain a drawing.");
    }
 else {
      throw new IOException("The document does not contain a drawing in namespace \"" + namespaceURI + "\".");
    }
  }
  external.set(Drawing.DOCUMENT_HOME,getDocumentHome());
  readProcessingInstructions(doc,external);
  try {
    for (    Map.Entry<Figure,Element> entry : figureToElementMap.entrySet()) {
      readElementAttributes(entry.getKey(),entry.getValue());
      readElementNodeList(entry.getKey(),entry.getValue());
    }
  }
  finally {
    figureToElementMap.clear();
  }
  if (external != null) {
    return factory.fromExternalDrawing(external);
  }
 else {
    throw new IOException(namespaceURI == null ? "document does not contain a drawing" : "document does not contain a drawing in namespace " + namespaceURI);
  }
}
