{
  try {
    ids.reset();
    DocumentBuilderFactory builderFactory=DocumentBuilderFactory.newInstance();
    Document doc;
    if (namespaceURI != null) {
      builderFactory.setNamespaceAware(true);
      DocumentBuilder builder=builderFactory.newDocumentBuilder();
      DOMImplementation domImpl=builder.getDOMImplementation();
      doc=domImpl.createDocument(namespaceURI,namespaceQualifier == null ? factory.figureToName(drawing) : namespaceQualifier + ":" + factory.figureToName(drawing),null);
    }
 else {
      DocumentBuilder builder=builderFactory.newDocumentBuilder();
      doc=builder.newDocument();
      Element elem=doc.createElement(factory.figureToName(drawing));
      doc.appendChild(elem);
    }
    Element docElement=doc.getDocumentElement();
    writeElementAttributes(docElement,drawing);
    for (    Figure child : drawing.getChildren()) {
      Node childNode=writeNodeRecursively(doc,child);
      if (childNode != null) {
        docElement.appendChild(childNode);
      }
    }
    return doc;
  }
 catch (  ParserConfigurationException ex) {
    throw new IOException(ex);
  }
}
