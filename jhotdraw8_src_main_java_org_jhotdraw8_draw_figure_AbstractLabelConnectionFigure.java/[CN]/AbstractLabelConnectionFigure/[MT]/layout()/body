{
  Figure labelTarget=get(LABEL_TARGET);
  if (labelTarget == null || labelTarget == this) {
    invalidateBounds();
    invalidateTransforms();
    return;
  }
  Point2D labeledLoc=get(LABELED_LOCATION);
  Connector labelConnector=get(LABEL_CONNECTOR);
  final Point2D perp;
  if (labelConnector != null && labelTarget != null) {
    labeledLoc=labelConnector.getPositionInWorld(this,labelTarget);
    final Point2D tangent=labelConnector.getTangentInWorld(this,labelTarget);
    perp=Geom.perp(Transforms.deltaTransform(getWorldToLocal(),tangent));
    labeledLoc=Transforms.transform(labelTarget.getParentToLocal(),labeledLoc);
    if (getStyled(LABEL_AUTOROTATE)) {
      double theta=Math.atan2(tangent.getY(),tangent.getX());
      set(ROTATE,theta * 180.0 / Math.PI);
    }
  }
 else {
    perp=new Point2D(0,-1);
  }
  set(LABELED_LOCATION,labeledLoc);
  Bounds b=getLayoutBounds();
  double tx=0;
switch (getStyled(TEXT_HPOS)) {
case CENTER:
    tx=b.getWidth() * -0.5;
  break;
case LEFT:
break;
case RIGHT:
tx=-b.getWidth();
break;
}
Point2D origin=labeledLoc.add(perp.multiply(getStyled(LABEL_OFFSET))).add(tx,0);
Point2D labelTranslation=getStyled(LABEL_TRANSLATE);
origin=origin.add(labelTranslation);
set(ORIGIN,origin);
if (labelTarget != null) {
setTransforms(labelTarget.getLocalToParent());
}
 else {
setTransforms();
}
invalidateBounds();
invalidateTransforms();
}
