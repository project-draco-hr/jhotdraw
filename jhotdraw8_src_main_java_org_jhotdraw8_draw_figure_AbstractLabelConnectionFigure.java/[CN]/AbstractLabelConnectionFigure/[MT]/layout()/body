{
  Figure labelTarget=get(LABEL_TARGET);
  final Point2D labeledLoc;
  Connector labelConnector=get(LABEL_CONNECTOR);
  final Point2D perp;
  final Point2D tangent;
  if (labelConnector != null && labelTarget != null) {
    labeledLoc=labelConnector.getPositionInWorld(this,labelTarget);
    tangent=labelConnector.getTangentInWorld(this,labelTarget);
    perp=Geom.perp(tangent);
  }
 else {
    labeledLoc=get(LABELED_LOCATION);
    tangent=new Point2D(1,0);
    perp=new Point2D(0,-1);
  }
switch (getStyled(LABEL_AUTOROTATE)) {
case FULL:
{
      final double theta=(Math.atan2(tangent.getY(),tangent.getX()) * 180.0 / Math.PI + 360.0) % 360.0;
      set(ROTATE,theta);
    }
  break;
case HALF:
{
  final double theta=(Math.atan2(tangent.getY(),tangent.getX()) * 180.0 / Math.PI + 360.0) % 360.0;
  final double halfTheta=theta <= 90.0 || theta > 270.0 ? theta : (theta + 180.0) % 360.0;
  set(ROTATE,halfTheta);
}
break;
case OFF:
default :
break;
}
set(LABELED_LOCATION,labeledLoc);
Bounds b=getLayoutBounds();
double tx=0;
switch (getStyled(TEXT_HPOS)) {
case CENTER:
tx=b.getWidth() * -0.5;
break;
case LEFT:
break;
case RIGHT:
tx=-b.getWidth();
break;
}
final double labelOffsetX=-getStyled(LABEL_OFFSET_X).getConvertedValue();
final double labelOffsetY=getStyled(LABEL_OFFSET_Y).getConvertedValue();
Point2D origin=labeledLoc.add(perp.multiply(-labelOffsetY)).add(tangent.multiply(labelOffsetX));
origin=origin.add(tx,0);
Point2D labelTranslation=getStyled(LABEL_TRANSLATE);
origin=origin.add(labelTranslation);
set(ORIGIN,origin);
if (labelTarget != null) {
setTransforms(labelTarget.getLocalToParent());
}
 else {
setTransforms();
}
Bounds bconnected=getLayoutBounds();
setCachedValue(BOUNDS_IN_LOCAL_CACHE_KEY,bconnected);
invalidateTransforms();
}
