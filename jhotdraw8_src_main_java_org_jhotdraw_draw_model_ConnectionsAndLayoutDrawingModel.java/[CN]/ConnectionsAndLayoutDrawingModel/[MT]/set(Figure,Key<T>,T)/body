{
  Set<Figure> connectionsBefore=null;
  if (key instanceof FigureKey) {
    FigureKey<T> fk=(FigureKey<T>)key;
    DirtyMask dm=fk.getDirtyMask();
    if (dm.containsOneOf(DirtyBits.CONNECTION)) {
      connectionsBefore=figure.getConnectionTargets();
    }
  }
  T oldValue=figure.set(key,newValue);
  if (oldValue != newValue) {
    if (key instanceof FigureKey) {
      FigureKey<T> fk=(FigureKey<T>)key;
      DirtyMask dm=fk.getDirtyMask();
      if (dm.containsOneOf(DirtyBits.NODE)) {
        fire(DrawingModelEvent.nodeInvalidated(this,figure));
      }
      if (dm.containsOneOf(DirtyBits.LAYOUT)) {
        fire(DrawingModelEvent.layoutInvalidated(this,figure));
      }
      if (dm.containsOneOf(DirtyBits.CONNECTION_LAYOUT)) {
        fireLayoutInvalidatedConnectedFigures(figure);
      }
      if (dm.containsOneOf(DirtyBits.CONNECTION)) {
        Set<Figure> connectionsAfter=figure.getConnectionTargets();
        if (!connectionsBefore.equals(connectionsAfter)) {
          Set<Figure> changed=new HashSet<>();
          changed.addAll(connectionsBefore);
          changed.addAll(connectionsAfter);
          for (          Figure f : changed) {
            fire(DrawingModelEvent.connectionChanged(this,f));
          }
        }
      }
    }
  }
  return oldValue;
}
